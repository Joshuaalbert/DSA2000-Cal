FROM python:3.11.7

RUN apt-get update && apt-get install -y gdb lldb sudo rsync
RUN pip install py-spy && chown root:root `which py-spy` && chmod u+s `which py-spy`

# requirements rarely change, so install those here
COPY ./dsa2000_cal/requirements.txt /dsa/code/requirements.txt
COPY ./dsa2000_cal/requirements-notebooks.txt /dsa/code/requirements-notebooks.txt
RUN pip install -r /dsa/code/requirements.txt
RUN pip install -r /dsa/code/requirements-notebooks.txt

# Copy entrypoint
COPY ./workflows/streaming_fm_distributed/ray/src /dsa/code/src

# Copy credentials to access content. The public key should allow access.
ARG SSH_PRIVATE_KEY
RUN mkdir -p /root/.ssh && chmod 700 /root/.ssh
COPY $SSH_PRIVATE_KEY /root/.ssh/id_rsa
RUN chmod 600 /root/.ssh/id_rsa

# For data persistence in the run directory
RUN mkdir -p /dsa/run
WORKDIR /dsa/run

ENTRYPOINT [ "/bin/bash", "/dsa/code/src/entrypoint.sh" ]